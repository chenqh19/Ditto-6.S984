# thrift

We use cog to automatically generate C++ source files for each microservice. The template input for cog is implemented in template_grpc.cpp and is called in src_files_gen.py. You can find how to use cog at [here](https://nedbatchelder.com/code/cog/).

In src_files_gen.py, we also format generated C++ files with clang-format and generate CMakeLists files for building and deploying use.

thrift_gen.py is used to generate thrift files (both C++ and lua) needed by thrift communications. These files will be included in the source code of each microservice.

lua_rewrite.py is used to reformat some lua scripts generated by thrift because these scripts will be included in the Nginx to transfer the http requests from client(wrk2) to rpc call. 

docker-compose_gen.py is used to generate docker-compose file for further deployment with docker compose.

auto.py is a wrapper script to invoke above scripts. You can set up the path to the configuration file that describe the topology of the application and this config would be needed by the other scripts. The "path" argument for auto.py defines which topology (in config/paths.json) to generate, you can refer the [README](https://github.com/Mingyu-Liang/topology_generator/blob/main/config/README.md) to find the description of these configuration files.



# TO CHANGE TOPOLOGY
- Modify config:
    - synthetic_social_network/config/services.json
    - synthetic_social_network/docker-compose.yml
    - synthetic_social_network/config/paths.json: in “edges” and “dependencies” of path_0, change all B to A, remove entry [A,B]
- Modify src code: (in folder synthetic_social_network/src/)
    - synthetic_social_network/src/CMakeLists.txt
    - copy function runAssembly0() in service_B/assembly.cpp to runAssembly1() in service_A/assembly.cpp
    - service_A/utils.h: add a function runAssembly1() with same parameters as runAssembly0()
    - service_A/CMakeLists.txt: 
        comment out ${THRIFT_GEN_CPP_DIR}/service_B.cpp
        add ${THRIFT_GEN_CPP_DIR}/{service_C.cpp, service_D.cpp}
    - service_A/service_A.cpp [KEY PART]
        comment out all code about service_B
        copy all code related to service_C, service_D from service_B/service_B.cpp, paste to the corresponding place in service_A/service_A.cpp
        add following code to rpc_A():

